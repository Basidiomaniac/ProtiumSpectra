# Script to import and prepare .asd files from field spectrometer
# Code adapted from appetizer_course_dm20251103.R
# Adapted by Laurel Miller, Nov 2025
# Inputs: folder(s) full of .asd files, metadata in .csv format
# Outputs: Dataframes of spectral data with metadata, functions to lengthen
# for plotting and a plotting function using ggplot2.
library(tidyverse)
library(asdreader)
library(viridis)
library(prospectr)
library(lubridate)
# functions
# provide a df containing spectral data, rows as samples, columns as wavelengths
lengthen = function(df) {
spectra_long <- df %>%
pivot_longer(
cols = starts_with("nm"),   # select wavelength columns
names_to = "wavelength",
values_to = "intensity"
) %>%
mutate(
wavelength = as.numeric(sub("nm", "", wavelength)) # convert nm350 â†’ 350
)
return(spectra_long)
}
spectra_plot = function(df_long, category) {
plot = ggplot(df_long, aes(x = wavelength, y = intensity, color = category, group = category)) +
geom_line(size = 0.8, alpha = 0.8) +
theme_minimal() +
labs(x = "Wavelength (nm)", y = "Reflectance",) +
theme(legend.position = "none") +
if (is.numeric(df_long$category)) {
plot <- plot + scale_color_viridis_c(option = "plasma")
} else {
plot <- plot + scale_color_viridis_d(option = "plasma")
}
plot
}
spectra_cleanup = function(df) {
spectra = df
colnames(spectra) <- paste("nm", colnames(spectra), sep = "")
rownames(spectra) <- sub(".*(?=Protium)", "", rownames(spectra), perl = TRUE)
spectra_clean = as.data.frame(spectra) %>%
mutate(sample = str_split_i(rownames(spectra), 'Protium', 2) %>%
str_split_i(., 'x', 1) %>%
as.numeric,
replicate = str_split_i(rownames(spectra), 'x', 2) %>%
str_split_i(., '.asd', 1) %>%
as.numeric) %>%
filter(!if_any(everything(), ~ str_detect(.x, "Inf"))) %>%
filter(!is.na(sample)) # remove white reading NA's
return(spectra)
}
# FILL IN DIRECTORIES FOR YOUR OWN FILES
asd_dir = '/home/girlmunculus/spectraProj/asd/' # location of .asd files
github_dir = '/home/girlmunculus/GitHub/ProtiumSpectra/' # location of GitHub project
# importing and plotting from asdreader as a reference file.
test_file = asd_file()
test_spectra = get_spectra(test_file)
head(test_spectra)
plot(as.numeric(test_spectra), type = 'l')
# read .asd files
setwd(asd_dir)
filepaths = list.files(pattern = "\\.asd$",
recursive = TRUE, full.names = TRUE)
# go through files, adding collection date and merging to main
spectra = get_spectra(filepaths, "reflectance")
# plot(as.numeric(spectra), type = 'l')
# clean nir data up
colnames(spectra) <- paste("nm", colnames(spectra), sep = "")
rownames(spectra) <- sub(".*(?=Protium)", "", rownames(spectra), perl = TRUE)
spectra_clean = as.data.frame(spectra) %>%
filter(!if_any(everything(), ~ str_detect(.x, "Inf"))) %>%
filter(if_any(everything(), ~ . < 1)) %>%
filter(!is.na(sample)) # remove white reading NA's
# splicing to fix steps in measurements caused by spectrometer's three scanners
# NOTE: This currently only fixes the 1000nm gap, not the 1801nm one.
spectra_spliced = spliceCorrection(X = spectra_clean, wav = 350:2500)
spectra_cleaner = spectra_spliced %>%
as.data.frame() %>%
mutate(sample = str_split_i(rownames(spectra_clean), 'Protium', 2) %>%
str_split_i(., 'x', 1) %>%
as.numeric,
replicate = str_split_i(rownames(spectra_clean), 'x', 2) %>%
str_split_i(., '.asd', 1) %>%
as.numeric) %>%
dplyr::select(sample, replicate, starts_with('nm')) %>%
mutate(sample = str_pad(sample, width = 3, side = "left", pad = "0"))
# turn spectra into long df for plotting (takes a bit)
# spectra_long = lengthen(spectra_clean)
# plot spectral chart (this takes a while)
# you can change 'color =' to groupings of interest (species, etc.)
# spectra_plot(spectra_long, spectra_long$sample)
# stepclass here
# read in the metadata on each sample
setwd(github_dir)
meta = read.csv('NIR_test_data_metadata.csv')
species = meta %>% mutate(sample = str_split_i(ViewSpecFile.Folder, 'Protium', 2) %>%
as.numeric) %>%
rename(population_lineage = population.lineage,
geographic_location = geographic.location,
date = DataFolder) %>%
dplyr::select(sample, species, population_lineage, geographic_location, date) %>%
mutate(sample = str_pad(sample, width = 3, side = "left", pad = "0"))
# combine species metadata with nir data
nir = spectra_cleaner %>% left_join(species, by = 'sample') %>%
dplyr::select(sample, replicate, species, population_lineage,
geographic_location, date, starts_with('nm')) %>%
mutate(date_parsed = parse_date_time(date, orders = "B y")) %>%
mutate(date_num = as.numeric(date_parsed))  # make date numeric for LDA later
wavelengths = grep("^nm", names(nir), value = TRUE)
nir = nir %>% filter(if_all(all_of(wavelengths), is.finite)) %>%
mutate_all(na_if,"") %>%
drop_na()
# means for each species, plot
nir_species = nir %>% group_by(specieslineage) %>%
summarize_at(vars(starts_with('nm')), mean)
View(nir)
nir_clean = nir %>%
mutate(across(where(is.character), ~ na_if(.x, ""))) %>%
filter(if_all(all_of(wavelengths), ~ is.finite(.x))) %>%
drop_na()
nir$specieslineage = paste(nir$species, "-", nir$population_lineage)
# means for each species, plot
nir_species = nir %>% group_by(specieslineage) %>%
summarize_at(vars(starts_with('nm')), mean)
nir_species = nir_species %>% pivot_longer(cols = starts_with('nm'),
names_to = 'wavelength',
names_prefix = 'nm',
values_to = 'reflectance_mean') %>%
mutate(wavelength = as.numeric(wavelength))
line_plot_species = ggplot(nir_species, aes(x = wavelength, y = reflectance_mean, color = specieslineage)) +
geom_line(aes(group = species)) +
scale_color_viridis_d(option = "plasma") +
facet_wrap(~ date)
line_plot_species
line_plot_species = ggplot(nir_species, aes(x = wavelength, y = reflectance_mean, color = specieslineage)) +
geom_line(aes(group = species)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
View(nir_species)
View(meta)
View(nir)
View(nir_species)
nir$table(nir$specieslineage)
table(nir$specieslineage)
View(nir_species)
table(nir_species$specieslineage)
line_plot_species = ggplot(nir_species, aes(x = wavelength, y = reflectance_mean, color = specieslineage)) +
geom_line(aes(group = species)) +
scale_color_viridis_d(option = "plasma")
line_plot_species = ggplot(nir_species, aes(x = wavelength, y = reflectance_mean, color = specieslineage)) +
geom_line(aes(group = specieslineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
# looking at lineages
subserratum = nir[nir$species == "subserratum",]
sub_lineage = subserratum %>% group_by(population_lineage) %>%
summarize_at(vars(starts_with('nm')), mean)
sub_lineage = sub_lineage %>% pivot_longer(cols = starts_with('nm'),
names_to = 'wavelength',
names_prefix = 'nm',
values_to = 'reflectance_mean') %>%
mutate(wavelength = as.numeric(wavelength))
line_plot_species = ggplot(sub_lineage, aes(x = wavelength, y = reflectance_mean, color = population_lineage)) +
geom_line(aes(group = species)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
View(nir)
line_plot_species = ggplot(sub_lineage, aes(x = wavelength, y = reflectance_mean, color = population_lineage)) +
geom_line(aes(group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
line_plot_species = ggplot(sub_lineage, aes(x = wavelength, y = reflectance_mean, color = population_lineage)) +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean))
line_plot_species = ggplot(sub_lineage, aes(x = wavelength, y = reflectance_mean, color = population_lineage)) +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean)) +
geom_line(aes(group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
line_plot_species = ggplot(sub_lineage, aes(x = wavelength, y = reflectance_mean, color = population_lineage)) +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean)) +
geom_line(data = sub_lineage, aes(group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
View(sub_lineage)
table(sub_lineage$population_lineage)
line_plot_species = ggplot(sub_lineage, aes(x = wavelength, y = reflectance_mean, color = population_lineage)) +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean)) +
geom_line(data = sub_lineage, aes(group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
line_plot_species = ggplot(sub_lineage, aes(x = wavelength, y = reflectance_mean, color = population_lineage)) +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean))
geom_line(data = sub_lineage, aes(group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
line_plot_species = ggplot() +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean)) +
geom_line(data = sub_lineage, aes(x=wavelength, y=reflectance_mean, group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
line_plot_species = ggplot() +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean)) +
geom_line(data = sub_lineage, aes(x=wavelength, y=reflectance_mean, color=population_lineage, group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
# removing April 23 (all values were 1?)
nir = nir[nir$date_num != 1680307200,]
nir$specieslineage = paste(nir$species, "-", nir$population_lineage)
nir_species = nir %>% group_by(species) %>%
summarize_at(vars(starts_with('nm')), mean)
nir_species = nir_species %>% pivot_longer(cols = starts_with('nm'),
names_to = 'wavelength',
names_prefix = 'nm',
values_to = 'reflectance_mean') %>%
mutate(wavelength = as.numeric(wavelength))
line_plot_species = ggplot(nir_species, aes(x = wavelength, y = reflectance_mean, color = specieslineage)) +
geom_line(aes(group = species)) +
scale_color_viridis_d(option = "plasma")
subserratum = nir[nir$species == "subserratum",]
sub_lineage = subserratum %>% group_by(population_lineage) %>%
summarize_at(vars(starts_with('nm')), mean)
sub_lineage = sub_lineage %>% pivot_longer(cols = starts_with('nm'),
names_to = 'wavelength',
names_prefix = 'nm',
values_to = 'reflectance_mean') %>%
mutate(wavelength = as.numeric(wavelength))
line_plot_species = ggplot() +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean)) +
geom_line(data = sub_lineage, aes(x=wavelength, y=reflectance_mean, color=population_lineage, group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
line_plot_species = ggplot() +
geom_line(data=nir_species, aes(x=wavelength, y=reflectance_mean), alpha = 0.5) +
geom_line(data = sub_lineage, aes(x=wavelength, y=reflectance_mean, color=population_lineage, group = population_lineage)) +
scale_color_viridis_d(option = "plasma")
line_plot_species
